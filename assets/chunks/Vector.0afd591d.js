import{e as et,l as Ze,I as je,B as Ke}from"./Vector.f72cf874.js";import{ar as ze,bx as qe,by as Ue,bh as bt,bz as pe,bA as Se,bB as $e,bl as ot,bn as Wt,bC as At,bD as St,bE as mt,bm as Pt,bo as vt,bp as Bt,r as Vt,bF as Qe,o as ee,bG as ti,bH as Z,ax as $,bI as nt,bJ as yt,bK as Gt,bL as De,bM as ei,k as Ct,bN as ii,b2 as Yt,bO as ni,au as ie,aq as ht,bu as me,bP as si,bQ as _t,bR as oi,bS as ye,aP as Xt,aK as Nt,bT as ri,b3 as Qt,bt as li,U as ai,bU as hi,Z as Ce,ap as xt,al as ci,an as Dt,as as Ot,a$ as di,bV as Ie,bW as fi,av as ui,aw as gi,m as _i,af as Ft,a3 as xi,bX as pi,n as Si}from"./reproj.50e0d4ab.js";const It={BEGIN_GEOMETRY:0,BEGIN_PATH:1,CIRCLE:2,CLOSE_PATH:3,CUSTOM:4,DRAW_CHARS:5,DRAW_IMAGE:6,END_GEOMETRY:7,FILL:8,MOVE_TO_LINE_TO:9,SET_FILL_STYLE:10,SET_STROKE_STYLE:11,STROKE:12},Mt=[It.FILL],it=[It.STROKE],st=[It.BEGIN_PATH],Te=[It.CLOSE_PATH],T=It;class mi{drawCustom(t,i,e,n){}drawGeometry(t){}setStyle(t){}drawCircle(t,i){}drawFeature(t,i){}drawGeometryCollection(t,i){}drawLineString(t,i){}drawMultiLineString(t,i){}drawMultiPoint(t,i){}drawMultiPolygon(t,i){}drawPoint(t,i){}drawPolygon(t,i){}drawText(t,i){}setFillStrokeStyle(t,i){}setImageStyle(t,i){}setTextStyle(t,i){}}const Oe=mi;class yi extends Oe{constructor(t,i,e,n){super(),this.tolerance=t,this.maxExtent=i,this.pixelRatio=n,this.maxLineWidth=0,this.resolution=e,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_=null,this.bufferedMaxExtent_=null,this.instructions=[],this.coordinates=[],this.tmpCoordinate_=[],this.hitDetectionInstructions=[],this.state={}}applyPixelRatio(t){const i=this.pixelRatio;return i==1?t:t.map(function(e){return e*i})}appendFlatPointCoordinates(t,i){const e=this.getBufferedMaxExtent(),n=this.tmpCoordinate_,s=this.coordinates;let o=s.length;for(let r=0,l=t.length;r<l;r+=i)n[0]=t[r],n[1]=t[r+1],ze(e,n)&&(s[o++]=n[0],s[o++]=n[1]);return o}appendFlatLineCoordinates(t,i,e,n,s,o){const r=this.coordinates;let l=r.length;const a=this.getBufferedMaxExtent();o&&(i+=n);let h=t[i],d=t[i+1];const c=this.tmpCoordinate_;let f=!0,u,x,g;for(u=i+n;u<e;u+=n)c[0]=t[u],c[1]=t[u+1],g=qe(a,c),g!==x?(f&&(r[l++]=h,r[l++]=d,f=!1),r[l++]=c[0],r[l++]=c[1]):g===Ue.INTERSECTING?(r[l++]=c[0],r[l++]=c[1],f=!1):f=!0,h=c[0],d=c[1],x=g;return(s&&f||u===i+n)&&(r[l++]=h,r[l++]=d),l}drawCustomCoordinates_(t,i,e,n,s){for(let o=0,r=e.length;o<r;++o){const l=e[o],a=this.appendFlatLineCoordinates(t,i,l,n,!1,!1);s.push(a),i=l}return i}drawCustom(t,i,e,n){this.beginGeometry(t,i);const s=t.getType(),o=t.getStride(),r=this.coordinates.length;let l,a,h,d,c;switch(s){case"MultiPolygon":l=t.getOrientedFlatCoordinates(),d=[];const f=t.getEndss();c=0;for(let u=0,x=f.length;u<x;++u){const g=[];c=this.drawCustomCoordinates_(l,c,f[u],o,g),d.push(g)}this.instructions.push([T.CUSTOM,r,d,t,e,Se]),this.hitDetectionInstructions.push([T.CUSTOM,r,d,t,n||e,Se]);break;case"Polygon":case"MultiLineString":h=[],l=s=="Polygon"?t.getOrientedFlatCoordinates():t.getFlatCoordinates(),c=this.drawCustomCoordinates_(l,0,t.getEnds(),o,h),this.instructions.push([T.CUSTOM,r,h,t,e,pe]),this.hitDetectionInstructions.push([T.CUSTOM,r,h,t,n||e,pe]);break;case"LineString":case"Circle":l=t.getFlatCoordinates(),a=this.appendFlatLineCoordinates(l,0,l.length,o,!1,!1),this.instructions.push([T.CUSTOM,r,a,t,e,bt]),this.hitDetectionInstructions.push([T.CUSTOM,r,a,t,n||e,bt]);break;case"MultiPoint":l=t.getFlatCoordinates(),a=this.appendFlatPointCoordinates(l,o),a>r&&(this.instructions.push([T.CUSTOM,r,a,t,e,bt]),this.hitDetectionInstructions.push([T.CUSTOM,r,a,t,n||e,bt]));break;case"Point":l=t.getFlatCoordinates(),this.coordinates.push(l[0],l[1]),a=this.coordinates.length,this.instructions.push([T.CUSTOM,r,a,t,e]),this.hitDetectionInstructions.push([T.CUSTOM,r,a,t,n||e]);break}this.endGeometry(i)}beginGeometry(t,i){this.beginGeometryInstruction1_=[T.BEGIN_GEOMETRY,i,0,t],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[T.BEGIN_GEOMETRY,i,0,t],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)}finish(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}}reverseHitDetectionInstructions(){const t=this.hitDetectionInstructions;t.reverse();let i;const e=t.length;let n,s,o=-1;for(i=0;i<e;++i)n=t[i],s=n[0],s==T.END_GEOMETRY?o=i:s==T.BEGIN_GEOMETRY&&(n[2]=i,$e(this.hitDetectionInstructions,o,i),o=-1)}setFillStrokeStyle(t,i){const e=this.state;if(t){const n=t.getColor();e.fillStyle=et(n||ot)}else e.fillStyle=void 0;if(i){const n=i.getColor();e.strokeStyle=et(n||Wt);const s=i.getLineCap();e.lineCap=s!==void 0?s:At;const o=i.getLineDash();e.lineDash=o?o.slice():St;const r=i.getLineDashOffset();e.lineDashOffset=r||mt;const l=i.getLineJoin();e.lineJoin=l!==void 0?l:Pt;const a=i.getWidth();e.lineWidth=a!==void 0?a:vt;const h=i.getMiterLimit();e.miterLimit=h!==void 0?h:Bt,e.lineWidth>this.maxLineWidth&&(this.maxLineWidth=e.lineWidth,this.bufferedMaxExtent_=null)}else e.strokeStyle=void 0,e.lineCap=void 0,e.lineDash=null,e.lineDashOffset=void 0,e.lineJoin=void 0,e.lineWidth=void 0,e.miterLimit=void 0}createFill(t){const i=t.fillStyle,e=[T.SET_FILL_STYLE,i];return typeof i!="string"&&e.push(!0),e}applyStroke(t){this.instructions.push(this.createStroke(t))}createStroke(t){return[T.SET_STROKE_STYLE,t.strokeStyle,t.lineWidth*this.pixelRatio,t.lineCap,t.lineJoin,t.miterLimit,this.applyPixelRatio(t.lineDash),t.lineDashOffset*this.pixelRatio]}updateFillStyle(t,i){const e=t.fillStyle;(typeof e!="string"||t.currentFillStyle!=e)&&(e!==void 0&&this.instructions.push(i.call(this,t)),t.currentFillStyle=e)}updateStrokeStyle(t,i){const e=t.strokeStyle,n=t.lineCap,s=t.lineDash,o=t.lineDashOffset,r=t.lineJoin,l=t.lineWidth,a=t.miterLimit;(t.currentStrokeStyle!=e||t.currentLineCap!=n||s!=t.currentLineDash&&!Vt(t.currentLineDash,s)||t.currentLineDashOffset!=o||t.currentLineJoin!=r||t.currentLineWidth!=l||t.currentMiterLimit!=a)&&(e!==void 0&&i.call(this,t),t.currentStrokeStyle=e,t.currentLineCap=n,t.currentLineDash=s,t.currentLineDashOffset=o,t.currentLineJoin=r,t.currentLineWidth=l,t.currentMiterLimit=a)}endGeometry(t){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;const i=[T.END_GEOMETRY,t];this.instructions.push(i),this.hitDetectionInstructions.push(i)}getBufferedMaxExtent(){if(!this.bufferedMaxExtent_&&(this.bufferedMaxExtent_=Qe(this.maxExtent),this.maxLineWidth>0)){const t=this.resolution*(this.maxLineWidth+1)/2;ee(this.bufferedMaxExtent_,t,this.bufferedMaxExtent_)}return this.bufferedMaxExtent_}}const Tt=yi;class Ci extends Tt{constructor(t,i,e,n){super(t,i,e,n),this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.anchorX_=void 0,this.anchorY_=void 0,this.height_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.scale_=void 0,this.width_=void 0,this.declutterMode_=void 0,this.declutterImageWithText_=void 0}drawPoint(t,i){if(!this.image_)return;this.beginGeometry(t,i);const e=t.getFlatCoordinates(),n=t.getStride(),s=this.coordinates.length,o=this.appendFlatPointCoordinates(e,n);this.instructions.push([T.DRAW_IMAGE,s,o,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([T.DRAW_IMAGE,s,o,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(i)}drawMultiPoint(t,i){if(!this.image_)return;this.beginGeometry(t,i);const e=t.getFlatCoordinates(),n=t.getStride(),s=this.coordinates.length,o=this.appendFlatPointCoordinates(e,n);this.instructions.push([T.DRAW_IMAGE,s,o,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([T.DRAW_IMAGE,s,o,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(i)}finish(){return this.reverseHitDetectionInstructions(),this.anchorX_=void 0,this.anchorY_=void 0,this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.height_=void 0,this.scale_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.width_=void 0,super.finish()}setImageStyle(t,i){const e=t.getAnchor(),n=t.getSize(),s=t.getOrigin();this.imagePixelRatio_=t.getPixelRatio(this.pixelRatio),this.anchorX_=e[0],this.anchorY_=e[1],this.hitDetectionImage_=t.getHitDetectionImage(),this.image_=t.getImage(this.pixelRatio),this.height_=n[1],this.opacity_=t.getOpacity(),this.originX_=s[0],this.originY_=s[1],this.rotateWithView_=t.getRotateWithView(),this.rotation_=t.getRotation(),this.scale_=t.getScaleArray(),this.width_=n[0],this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=i}}const Ii=Ci;class Ti extends Tt{constructor(t,i,e,n){super(t,i,e,n)}drawFlatCoordinates_(t,i,e,n){const s=this.coordinates.length,o=this.appendFlatLineCoordinates(t,i,e,n,!1,!1),r=[T.MOVE_TO_LINE_TO,s,o];return this.instructions.push(r),this.hitDetectionInstructions.push(r),e}drawLineString(t,i){const e=this.state,n=e.strokeStyle,s=e.lineWidth;if(n===void 0||s===void 0)return;this.updateStrokeStyle(e,this.applyStroke),this.beginGeometry(t,i),this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,e.strokeStyle,e.lineWidth,e.lineCap,e.lineJoin,e.miterLimit,St,mt],st);const o=t.getFlatCoordinates(),r=t.getStride();this.drawFlatCoordinates_(o,0,o.length,r),this.hitDetectionInstructions.push(it),this.endGeometry(i)}drawMultiLineString(t,i){const e=this.state,n=e.strokeStyle,s=e.lineWidth;if(n===void 0||s===void 0)return;this.updateStrokeStyle(e,this.applyStroke),this.beginGeometry(t,i),this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,e.strokeStyle,e.lineWidth,e.lineCap,e.lineJoin,e.miterLimit,e.lineDash,e.lineDashOffset],st);const o=t.getEnds(),r=t.getFlatCoordinates(),l=t.getStride();let a=0;for(let h=0,d=o.length;h<d;++h)a=this.drawFlatCoordinates_(r,a,o[h],l);this.hitDetectionInstructions.push(it),this.endGeometry(i)}finish(){const t=this.state;return t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&this.instructions.push(it),this.reverseHitDetectionInstructions(),this.state=null,super.finish()}applyStroke(t){t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&(this.instructions.push(it),t.lastStroke=this.coordinates.length),t.lastStroke=0,super.applyStroke(t),this.instructions.push(st)}}const Ri=Ti;class ki extends Tt{constructor(t,i,e,n){super(t,i,e,n)}drawFlatCoordinatess_(t,i,e,n){const s=this.state,o=s.fillStyle!==void 0,r=s.strokeStyle!==void 0,l=e.length;this.instructions.push(st),this.hitDetectionInstructions.push(st);for(let a=0;a<l;++a){const h=e[a],d=this.coordinates.length,c=this.appendFlatLineCoordinates(t,i,h,n,!0,!r),f=[T.MOVE_TO_LINE_TO,d,c];this.instructions.push(f),this.hitDetectionInstructions.push(f),r&&(this.instructions.push(Te),this.hitDetectionInstructions.push(Te)),i=h}return o&&(this.instructions.push(Mt),this.hitDetectionInstructions.push(Mt)),r&&(this.instructions.push(it),this.hitDetectionInstructions.push(it)),i}drawCircle(t,i){const e=this.state,n=e.fillStyle,s=e.strokeStyle;if(n===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,i),e.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,ot]),e.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,e.strokeStyle,e.lineWidth,e.lineCap,e.lineJoin,e.miterLimit,e.lineDash,e.lineDashOffset]);const o=t.getFlatCoordinates(),r=t.getStride(),l=this.coordinates.length;this.appendFlatLineCoordinates(o,0,o.length,r,!1,!1);const a=[T.CIRCLE,l];this.instructions.push(st,a),this.hitDetectionInstructions.push(st,a),e.fillStyle!==void 0&&(this.instructions.push(Mt),this.hitDetectionInstructions.push(Mt)),e.strokeStyle!==void 0&&(this.instructions.push(it),this.hitDetectionInstructions.push(it)),this.endGeometry(i)}drawPolygon(t,i){const e=this.state,n=e.fillStyle,s=e.strokeStyle;if(n===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,i),e.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,ot]),e.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,e.strokeStyle,e.lineWidth,e.lineCap,e.lineJoin,e.miterLimit,e.lineDash,e.lineDashOffset]);const o=t.getEnds(),r=t.getOrientedFlatCoordinates(),l=t.getStride();this.drawFlatCoordinatess_(r,0,o,l),this.endGeometry(i)}drawMultiPolygon(t,i){const e=this.state,n=e.fillStyle,s=e.strokeStyle;if(n===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,i),e.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,ot]),e.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,e.strokeStyle,e.lineWidth,e.lineCap,e.lineJoin,e.miterLimit,e.lineDash,e.lineDashOffset]);const o=t.getEndss(),r=t.getOrientedFlatCoordinates(),l=t.getStride();let a=0;for(let h=0,d=o.length;h<d;++h)a=this.drawFlatCoordinatess_(r,a,o[h],l);this.endGeometry(i)}finish(){this.reverseHitDetectionInstructions(),this.state=null;const t=this.tolerance;if(t!==0){const i=this.coordinates;for(let e=0,n=i.length;e<n;++e)i[e]=ti(i[e],t)}return super.finish()}setFillStrokeStyles_(){const t=this.state;t.fillStyle!==void 0&&this.updateFillStyle(t,this.createFill),t.strokeStyle!==void 0&&this.updateStrokeStyle(t,this.applyStroke)}}const Re=ki;function wi(_,t,i,e,n){const s=[];let o=i,r=0,l=t.slice(i,2);for(;r<_&&o+n<e;){const[a,h]=l.slice(-2),d=t[o+n],c=t[o+n+1],f=Math.sqrt((d-a)*(d-a)+(c-h)*(c-h));if(r+=f,r>=_){const u=(_-r+f)/f,x=Z(a,d,u),g=Z(h,c,u);l.push(x,g),s.push(l),l=[x,g],r==_&&(o+=n),r=0}else if(r<_)l.push(t[o+n],t[o+n+1]),o+=n;else{const u=f-r,x=Z(a,d,u/f),g=Z(h,c,u/f);l.push(x,g),s.push(l),l=[x,g],r=0,o+=n}}return r>0&&s.push(l),s}function Li(_,t,i,e,n){let s=i,o=i,r=0,l=0,a=i,h,d,c,f,u,x,g,p,m,y;for(d=i;d<e;d+=n){const I=t[d],C=t[d+1];u!==void 0&&(m=I-u,y=C-x,f=Math.sqrt(m*m+y*y),g!==void 0&&(l+=c,h=Math.acos((g*m+p*y)/(c*f)),h>_&&(l>r&&(r=l,s=a,o=d),l=0,a=d-n)),c=f,g=m,p=y),u=I,x=C}return l+=f,l>r?[a,d]:[s,o]}const pt={left:0,end:0,center:.5,right:1,start:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1};class Ei extends Tt{constructor(t,i,e,n){super(t,i,e,n),this.labels_=null,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=void 0,this.textRotation_=0,this.textFillState_=null,this.fillStates={},this.textStrokeState_=null,this.strokeStates={},this.textState_={},this.textStates={},this.textKey_="",this.fillKey_="",this.strokeKey_="",this.declutterImageWithText_=void 0}finish(){const t=super.finish();return t.textStates=this.textStates,t.fillStates=this.fillStates,t.strokeStates=this.strokeStates,t}drawText(t,i){const e=this.textFillState_,n=this.textStrokeState_,s=this.textState_;if(this.text_===""||!s||!e&&!n)return;const o=this.coordinates;let r=o.length;const l=t.getType();let a=null,h=t.getStride();if(s.placement==="line"&&(l=="LineString"||l=="MultiLineString"||l=="Polygon"||l=="MultiPolygon")){if(!$(this.getBufferedMaxExtent(),t.getExtent()))return;let d;if(a=t.getFlatCoordinates(),l=="LineString")d=[a.length];else if(l=="MultiLineString")d=t.getEnds();else if(l=="Polygon")d=t.getEnds().slice(0,1);else if(l=="MultiPolygon"){const x=t.getEndss();d=[];for(let g=0,p=x.length;g<p;++g)d.push(x[g][0])}this.beginGeometry(t,i);const c=s.repeat,f=c?void 0:s.textAlign;let u=0;for(let x=0,g=d.length;x<g;++x){let p;c?p=wi(c*this.resolution,a,u,d[x],h):p=[a.slice(u,d[x])];for(let m=0,y=p.length;m<y;++m){const I=p[m];let C=0,E=I.length;if(f==null){const k=Li(s.maxAngle,I,0,I.length,2);C=k[0],E=k[1]}for(let k=C;k<E;k+=h)o.push(I[k],I[k+1]);const D=o.length;u=d[x],this.drawChars_(r,D),r=D}}this.endGeometry(i)}else{let d=s.overflow?null:[];switch(l){case"Point":case"MultiPoint":a=t.getFlatCoordinates();break;case"LineString":a=t.getFlatMidpoint();break;case"Circle":a=t.getCenter();break;case"MultiLineString":a=t.getFlatMidpoints(),h=2;break;case"Polygon":a=t.getFlatInteriorPoint(),s.overflow||d.push(a[2]/this.resolution),h=3;break;case"MultiPolygon":const g=t.getFlatInteriorPoints();a=[];for(let p=0,m=g.length;p<m;p+=3)s.overflow||d.push(g[p+2]/this.resolution),a.push(g[p],g[p+1]);if(a.length===0)return;h=2;break}const c=this.appendFlatPointCoordinates(a,h);if(c===r)return;if(d&&(c-r)/2!==a.length/h){let g=r/2;d=d.filter((p,m)=>{const y=o[(g+m)*2]===a[m*h]&&o[(g+m)*2+1]===a[m*h+1];return y||--g,y})}this.saveTextStates_(),(s.backgroundFill||s.backgroundStroke)&&(this.setFillStrokeStyle(s.backgroundFill,s.backgroundStroke),s.backgroundFill&&(this.updateFillStyle(this.state,this.createFill),this.hitDetectionInstructions.push(this.createFill(this.state))),s.backgroundStroke&&(this.updateStrokeStyle(this.state,this.applyStroke),this.hitDetectionInstructions.push(this.createStroke(this.state)))),this.beginGeometry(t,i);let f=s.padding;if(f!=nt&&(s.scale[0]<0||s.scale[1]<0)){let g=s.padding[0],p=s.padding[1],m=s.padding[2],y=s.padding[3];s.scale[0]<0&&(p=-p,y=-y),s.scale[1]<0&&(g=-g,m=-m),f=[g,p,m,y]}const u=this.pixelRatio;this.instructions.push([T.DRAW_IMAGE,r,c,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[1,1],NaN,void 0,this.declutterImageWithText_,f==nt?nt:f.map(function(g){return g*u}),!!s.backgroundFill,!!s.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,d]);const x=1/u;this.hitDetectionInstructions.push([T.DRAW_IMAGE,r,c,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[x,x],NaN,void 0,this.declutterImageWithText_,f,!!s.backgroundFill,!!s.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,d]),this.endGeometry(i)}}saveTextStates_(){const t=this.textStrokeState_,i=this.textState_,e=this.textFillState_,n=this.strokeKey_;t&&(n in this.strokeStates||(this.strokeStates[n]={strokeStyle:t.strokeStyle,lineCap:t.lineCap,lineDashOffset:t.lineDashOffset,lineWidth:t.lineWidth,lineJoin:t.lineJoin,miterLimit:t.miterLimit,lineDash:t.lineDash}));const s=this.textKey_;s in this.textStates||(this.textStates[s]={font:i.font,textAlign:i.textAlign||yt,justify:i.justify,textBaseline:i.textBaseline||Gt,scale:i.scale});const o=this.fillKey_;e&&(o in this.fillStates||(this.fillStates[o]={fillStyle:e.fillStyle}))}drawChars_(t,i){const e=this.textStrokeState_,n=this.textState_,s=this.strokeKey_,o=this.textKey_,r=this.fillKey_;this.saveTextStates_();const l=this.pixelRatio,a=pt[n.textBaseline],h=this.textOffsetY_*l,d=this.text_,c=e?e.lineWidth*Math.abs(n.scale[0])/2:0;this.instructions.push([T.DRAW_CHARS,t,i,a,n.overflow,r,n.maxAngle,l,h,s,c*l,d,o,1]),this.hitDetectionInstructions.push([T.DRAW_CHARS,t,i,a,n.overflow,r,n.maxAngle,1,h,s,c,d,o,1/l])}setTextStyle(t,i){let e,n,s;if(!t)this.text_="";else{const o=t.getFill();o?(n=this.textFillState_,n||(n={},this.textFillState_=n),n.fillStyle=et(o.getColor()||ot)):(n=null,this.textFillState_=n);const r=t.getStroke();if(!r)s=null,this.textStrokeState_=s;else{s=this.textStrokeState_,s||(s={},this.textStrokeState_=s);const u=r.getLineDash(),x=r.getLineDashOffset(),g=r.getWidth(),p=r.getMiterLimit();s.lineCap=r.getLineCap()||At,s.lineDash=u?u.slice():St,s.lineDashOffset=x===void 0?mt:x,s.lineJoin=r.getLineJoin()||Pt,s.lineWidth=g===void 0?vt:g,s.miterLimit=p===void 0?Bt:p,s.strokeStyle=et(r.getColor()||Wt)}e=this.textState_;const l=t.getFont()||De;ei(l);const a=t.getScaleArray();e.overflow=t.getOverflow(),e.font=l,e.maxAngle=t.getMaxAngle(),e.placement=t.getPlacement(),e.textAlign=t.getTextAlign(),e.repeat=t.getRepeat(),e.justify=t.getJustify(),e.textBaseline=t.getTextBaseline()||Gt,e.backgroundFill=t.getBackgroundFill(),e.backgroundStroke=t.getBackgroundStroke(),e.padding=t.getPadding()||nt,e.scale=a===void 0?[1,1]:a;const h=t.getOffsetX(),d=t.getOffsetY(),c=t.getRotateWithView(),f=t.getRotation();this.text_=t.getText()||"",this.textOffsetX_=h===void 0?0:h,this.textOffsetY_=d===void 0?0:d,this.textRotateWithView_=c===void 0?!1:c,this.textRotation_=f===void 0?0:f,this.strokeKey_=s?(typeof s.strokeStyle=="string"?s.strokeStyle:Ct(s.strokeStyle))+s.lineCap+s.lineDashOffset+"|"+s.lineWidth+s.lineJoin+s.miterLimit+"["+s.lineDash.join()+"]":"",this.textKey_=e.font+e.scale+(e.textAlign||"?")+(e.repeat||"?")+(e.justify||"?")+(e.textBaseline||"?"),this.fillKey_=n?typeof n.fillStyle=="string"?n.fillStyle:"|"+Ct(n.fillStyle):""}this.declutterImageWithText_=i}}const bi={Circle:Re,Default:Tt,Image:Ii,LineString:Ri,Polygon:Re,Text:Ei};class Di{constructor(t,i,e,n){this.tolerance_=t,this.maxExtent_=i,this.pixelRatio_=n,this.resolution_=e,this.buildersByZIndex_={}}finish(){const t={};for(const i in this.buildersByZIndex_){t[i]=t[i]||{};const e=this.buildersByZIndex_[i];for(const n in e){const s=e[n].finish();t[i][n]=s}}return t}getBuilder(t,i){const e=t!==void 0?t.toString():"0";let n=this.buildersByZIndex_[e];n===void 0&&(n={},this.buildersByZIndex_[e]=n);let s=n[i];if(s===void 0){const o=bi[i];s=new o(this.tolerance_,this.maxExtent_,this.resolution_,this.pixelRatio_),n[i]=s}return s}}const ke=Di;function Oi(_,t,i,e,n,s,o,r,l,a,h,d){let c=_[t],f=_[t+1],u=0,x=0,g=0,p=0;function m(){u=c,x=f,t+=e,c=_[t],f=_[t+1],p+=g,g=Math.sqrt((c-u)*(c-u)+(f-x)*(f-x))}do m();while(t<i-e&&p+g<s);let y=g===0?0:(s-p)/g;const I=Z(u,c,y),C=Z(x,f,y),E=t-e,D=p,k=s+r*l(a,n,h);for(;t<i-e&&p+g<k;)m();y=g===0?0:(k-p)/g;const b=Z(u,c,y),O=Z(x,f,y);let A;if(d){const L=[I,C,b,O];ii(L,0,4,2,d,L,L),A=L[0]>L[2]}else A=I>b;const W=Math.PI,F=[],G=E+e===t;t=E,g=0,p=D,c=_[t],f=_[t+1];let R;if(G){m(),R=Math.atan2(f-x,c-u),A&&(R+=R>0?-W:W);const L=(b+I)/2,w=(O+C)/2;return F[0]=[L,w,(k-s)/2,R,n],F}n=n.replace(/\n/g," ");for(let L=0,w=n.length;L<w;){m();let M=Math.atan2(f-x,c-u);if(A&&(M+=M>0?-W:W),R!==void 0){let H=M-R;if(H+=H>W?-2*W:H<-W?2*W:0,Math.abs(H)>o)return null}R=M;const P=L;let v=0;for(;L<w;++L){const H=A?w-L-1:L,rt=r*l(a,n[H],h);if(t+e<i&&p+g<s+v+rt/2)break;v+=rt}if(L===P)continue;const J=A?n.substring(w-P,w-L):n.substring(P,L);y=g===0?0:(s+v/2-p)/g;const S=Z(u,c,y),ne=Z(x,f,y);F.push([S,ne,v/2,M,J]),s+=v}return F}const at=Xt(),Q=[],q=[],U=[],tt=[];function we(_){return _[3].declutterBox}const Fi=new RegExp("["+String.fromCharCode(1425)+"-"+String.fromCharCode(2303)+String.fromCharCode(64285)+"-"+String.fromCharCode(65023)+String.fromCharCode(65136)+"-"+String.fromCharCode(65276)+String.fromCharCode(67584)+"-"+String.fromCharCode(69631)+String.fromCharCode(124928)+"-"+String.fromCharCode(126975)+"]");function Le(_,t){return(t==="start"||t==="end")&&!Fi.test(_)&&(t=t==="start"?"left":"right"),pt[t]}function Mi(_,t,i){return i>0&&_.push(`
`,""),_.push(t,""),_}class Wi{constructor(t,i,e,n){this.overlaps=e,this.pixelRatio=i,this.resolution=t,this.alignFill_,this.instructions=n.instructions,this.coordinates=n.coordinates,this.coordinateCache_={},this.renderedTransform_=Yt(),this.hitDetectionInstructions=n.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=n.fillStates||{},this.strokeStates=n.strokeStates||{},this.textStates=n.textStates||{},this.widths_={},this.labels_={}}createLabel(t,i,e,n){const s=t+i+e+n;if(this.labels_[s])return this.labels_[s];const o=n?this.strokeStates[n]:null,r=e?this.fillStates[e]:null,l=this.textStates[i],a=this.pixelRatio,h=[l.scale[0]*a,l.scale[1]*a],d=Array.isArray(t),c=l.justify?pt[l.justify]:Le(Array.isArray(t)?t[0]:t,l.textAlign||yt),f=n&&o.lineWidth?o.lineWidth:0,u=d?t:t.split(`
`).reduce(Mi,[]),{width:x,height:g,widths:p,heights:m,lineWidths:y}=ni(l,u),I=x+f,C=[],E=(I+2)*h[0],D=(g+f)*h[1],k={width:E<0?Math.floor(E):Math.ceil(E),height:D<0?Math.floor(D):Math.ceil(D),contextInstructions:C};(h[0]!=1||h[1]!=1)&&C.push("scale",h),n&&(C.push("strokeStyle",o.strokeStyle),C.push("lineWidth",f),C.push("lineCap",o.lineCap),C.push("lineJoin",o.lineJoin),C.push("miterLimit",o.miterLimit),C.push("setLineDash",[o.lineDash]),C.push("lineDashOffset",o.lineDashOffset)),e&&C.push("fillStyle",r.fillStyle),C.push("textBaseline","middle"),C.push("textAlign","center");const b=.5-c;let O=c*I+b*f;const A=[],W=[];let F=0,G=0,R=0,L=0,w;for(let M=0,P=u.length;M<P;M+=2){const v=u[M];if(v===`
`){G+=F,F=0,O=c*I+b*f,++L;continue}const J=u[M+1]||l.font;J!==w&&(n&&A.push("font",J),e&&W.push("font",J),w=J),F=Math.max(F,m[R]);const S=[v,O+b*p[R]+c*(p[R]-y[L]),.5*(f+F)+G];O+=p[R],n&&A.push("strokeText",S),e&&W.push("fillText",S),++R}return Array.prototype.push.apply(C,A),Array.prototype.push.apply(C,W),this.labels_[s]=k,k}replayTextBackground_(t,i,e,n,s,o,r){t.beginPath(),t.moveTo.apply(t,i),t.lineTo.apply(t,e),t.lineTo.apply(t,n),t.lineTo.apply(t,s),t.lineTo.apply(t,i),o&&(this.alignFill_=o[2],this.fill_(t)),r&&(this.setStrokeStyle_(t,r),t.stroke())}calculateImageOrLabelDimensions_(t,i,e,n,s,o,r,l,a,h,d,c,f,u,x,g){r*=c[0],l*=c[1];let p=e-r,m=n-l;const y=s+a>t?t-a:s,I=o+h>i?i-h:o,C=u[3]+y*c[0]+u[1],E=u[0]+I*c[1]+u[2],D=p-u[3],k=m-u[0];(x||d!==0)&&(Q[0]=D,tt[0]=D,Q[1]=k,q[1]=k,q[0]=D+C,U[0]=q[0],U[1]=k+E,tt[1]=U[1]);let b;return d!==0?(b=ie(Yt(),e,n,1,1,d,-e,-n),ht(b,Q),ht(b,q),ht(b,U),ht(b,tt),me(Math.min(Q[0],q[0],U[0],tt[0]),Math.min(Q[1],q[1],U[1],tt[1]),Math.max(Q[0],q[0],U[0],tt[0]),Math.max(Q[1],q[1],U[1],tt[1]),at)):me(Math.min(D,D+C),Math.min(k,k+E),Math.max(D,D+C),Math.max(k,k+E),at),f&&(p=Math.round(p),m=Math.round(m)),{drawImageX:p,drawImageY:m,drawImageW:y,drawImageH:I,originX:a,originY:h,declutterBox:{minX:at[0],minY:at[1],maxX:at[2],maxY:at[3],value:g},canvasTransform:b,scale:c}}replayImageOrLabel_(t,i,e,n,s,o,r){const l=!!(o||r),a=n.declutterBox,h=t.canvas,d=r?r[2]*n.scale[0]/2:0;return a.minX-d<=h.width/i&&a.maxX+d>=0&&a.minY-d<=h.height/i&&a.maxY+d>=0&&(l&&this.replayTextBackground_(t,Q,q,U,tt,o,r),si(t,n.canvasTransform,s,e,n.originX,n.originY,n.drawImageW,n.drawImageH,n.drawImageX,n.drawImageY,n.scale)),!0}fill_(t){if(this.alignFill_){const i=ht(this.renderedTransform_,[0,0]),e=512*this.pixelRatio;t.save(),t.translate(i[0]%e,i[1]%e),t.rotate(this.viewRotation_)}t.fill(),this.alignFill_&&t.restore()}setStrokeStyle_(t,i){t.strokeStyle=i[1],t.lineWidth=i[2],t.lineCap=i[3],t.lineJoin=i[4],t.miterLimit=i[5],t.lineDashOffset=i[7],t.setLineDash(i[6])}drawLabelWithPointPlacement_(t,i,e,n){const s=this.textStates[i],o=this.createLabel(t,i,n,e),r=this.strokeStates[e],l=this.pixelRatio,a=Le(Array.isArray(t)?t[0]:t,s.textAlign||yt),h=pt[s.textBaseline||Gt],d=r&&r.lineWidth?r.lineWidth:0,c=o.width/l-2*s.scale[0],f=a*c+2*(.5-a)*d,u=h*o.height/l+2*(.5-h)*d;return{label:o,anchorX:f,anchorY:u}}execute_(t,i,e,n,s,o,r,l){let a;this.pixelCoordinates_&&Vt(e,this.renderedTransform_)?a=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),a=_t(this.coordinates,0,this.coordinates.length,2,e,this.pixelCoordinates_),oi(this.renderedTransform_,e));let h=0;const d=n.length;let c=0,f,u,x,g,p,m,y,I,C,E,D,k,b=0,O=0,A=null,W=null;const F=this.coordinateCache_,G=this.viewRotation_,R=Math.round(Math.atan2(-e[1],e[0])*1e12)/1e12,L={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:G},w=this.instructions!=n||this.overlaps?0:200;let M,P,v,J;for(;h<d;){const S=n[h];switch(S[0]){case T.BEGIN_GEOMETRY:M=S[1],J=S[3],M.getGeometry()?r!==void 0&&!$(r,J.getExtent())?h=S[2]+1:++h:h=S[2];break;case T.BEGIN_PATH:b>w&&(this.fill_(t),b=0),O>w&&(t.stroke(),O=0),!b&&!O&&(t.beginPath(),g=NaN,p=NaN),++h;break;case T.CIRCLE:c=S[1];const H=a[c],rt=a[c+1],We=a[c+2],Ae=a[c+3],se=We-H,oe=Ae-rt,re=Math.sqrt(se*se+oe*oe);t.moveTo(H+re,rt),t.arc(H,rt,re,0,2*Math.PI,!0),++h;break;case T.CLOSE_PATH:t.closePath(),++h;break;case T.CUSTOM:c=S[1],f=S[2];const Pe=S[3],ve=S[4],le=S.length==6?S[5]:void 0;L.geometry=Pe,L.feature=M,h in F||(F[h]=[]);const ct=F[h];le?le(a,c,f,2,ct):(ct[0]=a[c],ct[1]=a[c+1],ct.length=2),ve(ct,L),++h;break;case T.DRAW_IMAGE:c=S[1],f=S[2],I=S[3],u=S[4],x=S[5];let Jt=S[6];const Be=S[7],Ge=S[8],Ye=S[9],ae=S[10];let Ht=S[11];const Xe=S[12];let Rt=S[13];const he=S[14],dt=S[15];if(!I&&S.length>=20){C=S[19],E=S[20],D=S[21],k=S[22];const Y=this.drawLabelWithPointPlacement_(C,E,D,k);I=Y.label,S[3]=I;const lt=S[23];u=(Y.anchorX-lt)*this.pixelRatio,S[4]=u;const N=S[24];x=(Y.anchorY-N)*this.pixelRatio,S[5]=x,Jt=I.height,S[6]=Jt,Rt=I.width,S[13]=Rt}let Zt;S.length>25&&(Zt=S[25]);let jt,kt,wt;S.length>17?(jt=S[16],kt=S[17],wt=S[18]):(jt=nt,kt=!1,wt=!1),ae&&R?Ht+=G:!ae&&!R&&(Ht-=G);let Ne=0;for(;c<f;c+=2){if(Zt&&Zt[Ne++]<Rt/this.pixelRatio)continue;const Y=this.calculateImageOrLabelDimensions_(I.width,I.height,a[c],a[c+1],Rt,Jt,u,x,Ge,Ye,Ht,Xe,s,jt,kt||wt,M),lt=[t,i,I,Y,Be,kt?A:null,wt?W:null];if(l){if(he==="none")continue;if(he==="obstacle"){l.insert(Y.declutterBox);continue}else{let N,K;if(dt){const X=f-c;if(!dt[X]){dt[X]=lt;continue}if(N=dt[X],delete dt[X],K=we(N),l.collides(K))continue}if(l.collides(Y.declutterBox))continue;N&&(l.insert(K),this.replayImageOrLabel_.apply(this,N)),l.insert(Y.declutterBox)}}this.replayImageOrLabel_.apply(this,lt)}++h;break;case T.DRAW_CHARS:const ce=S[1],de=S[2],Kt=S[3],Ve=S[4];k=S[5];const Je=S[6],fe=S[7],ue=S[8];D=S[9];const zt=S[10];C=S[11],E=S[12];const ge=[S[13],S[13]],qt=this.textStates[E],ft=qt.font,ut=[qt.scale[0]*fe,qt.scale[1]*fe];let gt;ft in this.widths_?gt=this.widths_[ft]:(gt={},this.widths_[ft]=gt);const _e=Ze(a,ce,de,2),xe=Math.abs(ut[0])*ye(ft,C,gt);if(Ve||xe<=_e){const Y=this.textStates[E].textAlign,lt=(_e-xe)*pt[Y],N=Oi(a,ce,de,2,C,lt,Je,Math.abs(ut[0]),ye,ft,gt,R?0:this.viewRotation_);t:if(N){const K=[];let X,Lt,Et,B,V;if(D)for(X=0,Lt=N.length;X<Lt;++X){V=N[X],Et=V[4],B=this.createLabel(Et,E,"",D),u=V[2]+(ut[0]<0?-zt:zt),x=Kt*B.height+(.5-Kt)*2*zt*ut[1]/ut[0]-ue;const z=this.calculateImageOrLabelDimensions_(B.width,B.height,V[0],V[1],B.width,B.height,u,x,0,0,V[3],ge,!1,nt,!1,M);if(l&&l.collides(z.declutterBox))break t;K.push([t,i,B,z,1,null,null])}if(k)for(X=0,Lt=N.length;X<Lt;++X){V=N[X],Et=V[4],B=this.createLabel(Et,E,k,""),u=V[2],x=Kt*B.height-ue;const z=this.calculateImageOrLabelDimensions_(B.width,B.height,V[0],V[1],B.width,B.height,u,x,0,0,V[3],ge,!1,nt,!1,M);if(l&&l.collides(z.declutterBox))break t;K.push([t,i,B,z,1,null,null])}l&&l.load(K.map(we));for(let z=0,He=K.length;z<He;++z)this.replayImageOrLabel_.apply(this,K[z])}}++h;break;case T.END_GEOMETRY:if(o!==void 0){M=S[1];const Y=o(M,J);if(Y)return Y}++h;break;case T.FILL:w?b++:this.fill_(t),++h;break;case T.MOVE_TO_LINE_TO:for(c=S[1],f=S[2],P=a[c],v=a[c+1],m=P+.5|0,y=v+.5|0,(m!==g||y!==p)&&(t.moveTo(P,v),g=m,p=y),c+=2;c<f;c+=2)P=a[c],v=a[c+1],m=P+.5|0,y=v+.5|0,(c==f-2||m!==g||y!==p)&&(t.lineTo(P,v),g=m,p=y);++h;break;case T.SET_FILL_STYLE:A=S,this.alignFill_=S[2],b&&(this.fill_(t),b=0,O&&(t.stroke(),O=0)),t.fillStyle=S[1],++h;break;case T.SET_STROKE_STYLE:W=S,O&&(t.stroke(),O=0),this.setStrokeStyle_(t,S),++h;break;case T.STROKE:w?O++:t.stroke(),++h;break;default:++h;break}}b&&this.fill_(t),O&&t.stroke()}execute(t,i,e,n,s,o){this.viewRotation_=n,this.execute_(t,i,e,this.instructions,s,void 0,void 0,o)}executeHitDetection(t,i,e,n,s){return this.viewRotation_=e,this.execute_(t,1,i,this.hitDetectionInstructions,!0,n,s)}}const Ai=Wi,Ut=["Polygon","Circle","LineString","Image","Text","Default"];class Pi{constructor(t,i,e,n,s,o){this.maxExtent_=t,this.overlaps_=n,this.pixelRatio_=e,this.resolution_=i,this.renderBuffer_=o,this.executorsByZIndex_={},this.hitDetectionContext_=null,this.hitDetectionTransform_=Yt(),this.createExecutors_(s)}clip(t,i){const e=this.getClipCoords(i);t.beginPath(),t.moveTo(e[0],e[1]),t.lineTo(e[2],e[3]),t.lineTo(e[4],e[5]),t.lineTo(e[6],e[7]),t.clip()}createExecutors_(t){for(const i in t){let e=this.executorsByZIndex_[i];e===void 0&&(e={},this.executorsByZIndex_[i]=e);const n=t[i];for(const s in n){const o=n[s];e[s]=new Ai(this.resolution_,this.pixelRatio_,this.overlaps_,o)}}}hasExecutors(t){for(const i in this.executorsByZIndex_){const e=this.executorsByZIndex_[i];for(let n=0,s=t.length;n<s;++n)if(t[n]in e)return!0}return!1}forEachFeatureAtCoordinate(t,i,e,n,s,o){n=Math.round(n);const r=n*2+1,l=ie(this.hitDetectionTransform_,n+.5,n+.5,1/i,-1/i,-e,-t[0],-t[1]),a=!this.hitDetectionContext_;a&&(this.hitDetectionContext_=Nt(r,r,void 0,{willReadFrequently:!0}));const h=this.hitDetectionContext_;h.canvas.width!==r||h.canvas.height!==r?(h.canvas.width=r,h.canvas.height=r):a||h.clearRect(0,0,r,r);let d;this.renderBuffer_!==void 0&&(d=Xt(),ri(d,t),ee(d,i*(this.renderBuffer_+n),d));const c=vi(n);let f;function u(C,E){const D=h.getImageData(0,0,r,r).data;for(let k=0,b=c.length;k<b;k++)if(D[c[k]]>0){if(!o||f!=="Image"&&f!=="Text"||o.includes(C)){const O=(c[k]-3)/4,A=n-O%r,W=n-(O/r|0),F=s(C,E,A*A+W*W);if(F)return F}h.clearRect(0,0,r,r);break}}const x=Object.keys(this.executorsByZIndex_).map(Number);x.sort(Qt);let g,p,m,y,I;for(g=x.length-1;g>=0;--g){const C=x[g].toString();for(m=this.executorsByZIndex_[C],p=Ut.length-1;p>=0;--p)if(f=Ut[p],y=m[f],y!==void 0&&(I=y.executeHitDetection(h,l,e,u,d),I))return I}}getClipCoords(t){const i=this.maxExtent_;if(!i)return null;const e=i[0],n=i[1],s=i[2],o=i[3],r=[e,n,e,o,s,o,s,n];return _t(r,0,8,2,t,r),r}isEmpty(){return li(this.executorsByZIndex_)}execute(t,i,e,n,s,o,r){const l=Object.keys(this.executorsByZIndex_).map(Number);l.sort(Qt),this.maxExtent_&&(t.save(),this.clip(t,e)),o=o||Ut;let a,h,d,c,f,u;for(r&&l.reverse(),a=0,h=l.length;a<h;++a){const x=l[a].toString();for(f=this.executorsByZIndex_[x],d=0,c=o.length;d<c;++d){const g=o[d];u=f[g],u!==void 0&&u.execute(t,i,e,n,s,r)}}this.maxExtent_&&t.restore()}}const $t={};function vi(_){if($t[_]!==void 0)return $t[_];const t=_*2+1,i=_*_,e=new Array(i+1);for(let s=0;s<=_;++s)for(let o=0;o<=_;++o){const r=s*s+o*o;if(r>i)break;let l=e[r];l||(l=[],e[r]=l),l.push(((_+s)*t+(_+o))*4+3),s>0&&l.push(((_-s)*t+(_+o))*4+3),o>0&&(l.push(((_+s)*t+(_-o))*4+3),s>0&&l.push(((_-s)*t+(_-o))*4+3))}const n=[];for(let s=0,o=e.length;s<o;++s)e[s]&&n.push(...e[s]);return $t[_]=n,n}const Ee=Pi;class Bi extends Oe{constructor(t,i,e,n,s,o,r){super(),this.context_=t,this.pixelRatio_=i,this.extent_=e,this.transform_=n,this.transformRotation_=n?ai(Math.atan2(n[1],n[0]),10):0,this.viewRotation_=s,this.squaredTolerance_=o,this.userTransform_=r,this.contextFillState_=null,this.contextStrokeState_=null,this.contextTextState_=null,this.fillState_=null,this.strokeState_=null,this.image_=null,this.imageAnchorX_=0,this.imageAnchorY_=0,this.imageHeight_=0,this.imageOpacity_=0,this.imageOriginX_=0,this.imageOriginY_=0,this.imageRotateWithView_=!1,this.imageRotation_=0,this.imageScale_=[0,0],this.imageWidth_=0,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=!1,this.textRotation_=0,this.textScale_=[0,0],this.textFillState_=null,this.textStrokeState_=null,this.textState_=null,this.pixelCoordinates_=[],this.tmpLocalTransform_=Yt()}drawImages_(t,i,e,n){if(!this.image_)return;const s=_t(t,i,e,n,this.transform_,this.pixelCoordinates_),o=this.context_,r=this.tmpLocalTransform_,l=o.globalAlpha;this.imageOpacity_!=1&&(o.globalAlpha=l*this.imageOpacity_);let a=this.imageRotation_;this.transformRotation_===0&&(a-=this.viewRotation_),this.imageRotateWithView_&&(a+=this.viewRotation_);for(let h=0,d=s.length;h<d;h+=2){const c=s[h]-this.imageAnchorX_,f=s[h+1]-this.imageAnchorY_;if(a!==0||this.imageScale_[0]!=1||this.imageScale_[1]!=1){const u=c+this.imageAnchorX_,x=f+this.imageAnchorY_;ie(r,u,x,1,1,a,-u,-x),o.setTransform.apply(o,r),o.translate(u,x),o.scale(this.imageScale_[0],this.imageScale_[1]),o.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,-this.imageAnchorX_,-this.imageAnchorY_,this.imageWidth_,this.imageHeight_),o.setTransform(1,0,0,1,0,0)}else o.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,c,f,this.imageWidth_,this.imageHeight_)}this.imageOpacity_!=1&&(o.globalAlpha=l)}drawText_(t,i,e,n){if(!this.textState_||this.text_==="")return;this.textFillState_&&this.setContextFillState_(this.textFillState_),this.textStrokeState_&&this.setContextStrokeState_(this.textStrokeState_),this.setContextTextState_(this.textState_);const s=_t(t,i,e,n,this.transform_,this.pixelCoordinates_),o=this.context_;let r=this.textRotation_;for(this.transformRotation_===0&&(r-=this.viewRotation_),this.textRotateWithView_&&(r+=this.viewRotation_);i<e;i+=n){const l=s[i]+this.textOffsetX_,a=s[i+1]+this.textOffsetY_;r!==0||this.textScale_[0]!=1||this.textScale_[1]!=1?(o.translate(l-this.textOffsetX_,a-this.textOffsetY_),o.rotate(r),o.translate(this.textOffsetX_,this.textOffsetY_),o.scale(this.textScale_[0],this.textScale_[1]),this.textStrokeState_&&o.strokeText(this.text_,0,0),this.textFillState_&&o.fillText(this.text_,0,0),o.setTransform(1,0,0,1,0,0)):(this.textStrokeState_&&o.strokeText(this.text_,l,a),this.textFillState_&&o.fillText(this.text_,l,a))}}moveToLineTo_(t,i,e,n,s){const o=this.context_,r=_t(t,i,e,n,this.transform_,this.pixelCoordinates_);o.moveTo(r[0],r[1]);let l=r.length;s&&(l-=2);for(let a=2;a<l;a+=2)o.lineTo(r[a],r[a+1]);return s&&o.closePath(),e}drawRings_(t,i,e,n){for(let s=0,o=e.length;s<o;++s)i=this.moveToLineTo_(t,i,e[s],n,!0);return i}drawCircle(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!$(this.extent_,t.getExtent())){if(this.fillState_||this.strokeState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const i=hi(t,this.transform_,this.pixelCoordinates_),e=i[2]-i[0],n=i[3]-i[1],s=Math.sqrt(e*e+n*n),o=this.context_;o.beginPath(),o.arc(i[0],i[1],s,0,2*Math.PI),this.fillState_&&o.fill(),this.strokeState_&&o.stroke()}this.text_!==""&&this.drawText_(t.getCenter(),0,2,2)}}setStyle(t){this.setFillStrokeStyle(t.getFill(),t.getStroke()),this.setImageStyle(t.getImage()),this.setTextStyle(t.getText())}setTransform(t){this.transform_=t}drawGeometry(t){switch(t.getType()){case"Point":this.drawPoint(t);break;case"LineString":this.drawLineString(t);break;case"Polygon":this.drawPolygon(t);break;case"MultiPoint":this.drawMultiPoint(t);break;case"MultiLineString":this.drawMultiLineString(t);break;case"MultiPolygon":this.drawMultiPolygon(t);break;case"GeometryCollection":this.drawGeometryCollection(t);break;case"Circle":this.drawCircle(t);break}}drawFeature(t,i){const e=i.getGeometryFunction()(t);e&&(this.setStyle(i),this.drawGeometry(e))}drawGeometryCollection(t){const i=t.getGeometriesArray();for(let e=0,n=i.length;e<n;++e)this.drawGeometry(i[e])}drawPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const i=t.getFlatCoordinates(),e=t.getStride();this.image_&&this.drawImages_(i,0,i.length,e),this.text_!==""&&this.drawText_(i,0,i.length,e)}drawMultiPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const i=t.getFlatCoordinates(),e=t.getStride();this.image_&&this.drawImages_(i,0,i.length,e),this.text_!==""&&this.drawText_(i,0,i.length,e)}drawLineString(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!$(this.extent_,t.getExtent())){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const i=this.context_,e=t.getFlatCoordinates();i.beginPath(),this.moveToLineTo_(e,0,e.length,t.getStride(),!1),i.stroke()}if(this.text_!==""){const i=t.getFlatMidpoint();this.drawText_(i,0,2,2)}}}drawMultiLineString(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const i=t.getExtent();if($(this.extent_,i)){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const e=this.context_,n=t.getFlatCoordinates();let s=0;const o=t.getEnds(),r=t.getStride();e.beginPath();for(let l=0,a=o.length;l<a;++l)s=this.moveToLineTo_(n,s,o[l],r,!1);e.stroke()}if(this.text_!==""){const e=t.getFlatMidpoints();this.drawText_(e,0,e.length,2)}}}drawPolygon(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!$(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const i=this.context_;i.beginPath(),this.drawRings_(t.getOrientedFlatCoordinates(),0,t.getEnds(),t.getStride()),this.fillState_&&i.fill(),this.strokeState_&&i.stroke()}if(this.text_!==""){const i=t.getFlatInteriorPoint();this.drawText_(i,0,2,2)}}}drawMultiPolygon(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!$(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const i=this.context_,e=t.getOrientedFlatCoordinates();let n=0;const s=t.getEndss(),o=t.getStride();i.beginPath();for(let r=0,l=s.length;r<l;++r){const a=s[r];n=this.drawRings_(e,n,a,o)}this.fillState_&&i.fill(),this.strokeState_&&i.stroke()}if(this.text_!==""){const i=t.getFlatInteriorPoints();this.drawText_(i,0,i.length,2)}}}setContextFillState_(t){const i=this.context_,e=this.contextFillState_;e?e.fillStyle!=t.fillStyle&&(e.fillStyle=t.fillStyle,i.fillStyle=t.fillStyle):(i.fillStyle=t.fillStyle,this.contextFillState_={fillStyle:t.fillStyle})}setContextStrokeState_(t){const i=this.context_,e=this.contextStrokeState_;e?(e.lineCap!=t.lineCap&&(e.lineCap=t.lineCap,i.lineCap=t.lineCap),Vt(e.lineDash,t.lineDash)||i.setLineDash(e.lineDash=t.lineDash),e.lineDashOffset!=t.lineDashOffset&&(e.lineDashOffset=t.lineDashOffset,i.lineDashOffset=t.lineDashOffset),e.lineJoin!=t.lineJoin&&(e.lineJoin=t.lineJoin,i.lineJoin=t.lineJoin),e.lineWidth!=t.lineWidth&&(e.lineWidth=t.lineWidth,i.lineWidth=t.lineWidth),e.miterLimit!=t.miterLimit&&(e.miterLimit=t.miterLimit,i.miterLimit=t.miterLimit),e.strokeStyle!=t.strokeStyle&&(e.strokeStyle=t.strokeStyle,i.strokeStyle=t.strokeStyle)):(i.lineCap=t.lineCap,i.setLineDash(t.lineDash),i.lineDashOffset=t.lineDashOffset,i.lineJoin=t.lineJoin,i.lineWidth=t.lineWidth,i.miterLimit=t.miterLimit,i.strokeStyle=t.strokeStyle,this.contextStrokeState_={lineCap:t.lineCap,lineDash:t.lineDash,lineDashOffset:t.lineDashOffset,lineJoin:t.lineJoin,lineWidth:t.lineWidth,miterLimit:t.miterLimit,strokeStyle:t.strokeStyle})}setContextTextState_(t){const i=this.context_,e=this.contextTextState_,n=t.textAlign?t.textAlign:yt;e?(e.font!=t.font&&(e.font=t.font,i.font=t.font),e.textAlign!=n&&(e.textAlign=n,i.textAlign=n),e.textBaseline!=t.textBaseline&&(e.textBaseline=t.textBaseline,i.textBaseline=t.textBaseline)):(i.font=t.font,i.textAlign=n,i.textBaseline=t.textBaseline,this.contextTextState_={font:t.font,textAlign:n,textBaseline:t.textBaseline})}setFillStrokeStyle(t,i){if(!t)this.fillState_=null;else{const e=t.getColor();this.fillState_={fillStyle:et(e||ot)}}if(!i)this.strokeState_=null;else{const e=i.getColor(),n=i.getLineCap(),s=i.getLineDash(),o=i.getLineDashOffset(),r=i.getLineJoin(),l=i.getWidth(),a=i.getMiterLimit(),h=s||St;this.strokeState_={lineCap:n!==void 0?n:At,lineDash:this.pixelRatio_===1?h:h.map(d=>d*this.pixelRatio_),lineDashOffset:(o||mt)*this.pixelRatio_,lineJoin:r!==void 0?r:Pt,lineWidth:(l!==void 0?l:vt)*this.pixelRatio_,miterLimit:a!==void 0?a:Bt,strokeStyle:et(e||Wt)}}}setImageStyle(t){let i;if(!t||!(i=t.getSize())){this.image_=null;return}const e=t.getPixelRatio(this.pixelRatio_),n=t.getAnchor(),s=t.getOrigin();this.image_=t.getImage(this.pixelRatio_),this.imageAnchorX_=n[0]*e,this.imageAnchorY_=n[1]*e,this.imageHeight_=i[1]*e,this.imageOpacity_=t.getOpacity(),this.imageOriginX_=s[0],this.imageOriginY_=s[1],this.imageRotateWithView_=t.getRotateWithView(),this.imageRotation_=t.getRotation();const o=t.getScaleArray();this.imageScale_=[o[0]*this.pixelRatio_/e,o[1]*this.pixelRatio_/e],this.imageWidth_=i[0]*e}setTextStyle(t){if(!t)this.text_="";else{const i=t.getFill();if(!i)this.textFillState_=null;else{const f=i.getColor();this.textFillState_={fillStyle:et(f||ot)}}const e=t.getStroke();if(!e)this.textStrokeState_=null;else{const f=e.getColor(),u=e.getLineCap(),x=e.getLineDash(),g=e.getLineDashOffset(),p=e.getLineJoin(),m=e.getWidth(),y=e.getMiterLimit();this.textStrokeState_={lineCap:u!==void 0?u:At,lineDash:x||St,lineDashOffset:g||mt,lineJoin:p!==void 0?p:Pt,lineWidth:m!==void 0?m:vt,miterLimit:y!==void 0?y:Bt,strokeStyle:et(f||Wt)}}const n=t.getFont(),s=t.getOffsetX(),o=t.getOffsetY(),r=t.getRotateWithView(),l=t.getRotation(),a=t.getScaleArray(),h=t.getText(),d=t.getTextAlign(),c=t.getTextBaseline();this.textState_={font:n!==void 0?n:De,textAlign:d!==void 0?d:yt,textBaseline:c!==void 0?c:Gt},this.text_=h!==void 0?Array.isArray(h)?h.reduce((f,u,x)=>f+=x%2?" ":u,""):h:"",this.textOffsetX_=s!==void 0?this.pixelRatio_*s:0,this.textOffsetY_=o!==void 0?this.pixelRatio_*o:0,this.textRotateWithView_=r!==void 0?r:!1,this.textRotation_=l!==void 0?l:0,this.textScale_=[this.pixelRatio_*a[0],this.pixelRatio_*a[1]]}}}const Gi=Bi,j=.5;function Yi(_,t,i,e,n,s,o){const r=_[0]*j,l=_[1]*j,a=Nt(r,l);a.imageSmoothingEnabled=!1;const h=a.canvas,d=new Gi(a,j,n,null,o),c=i.length,f=Math.floor((256*256*256-1)/c),u={};for(let g=1;g<=c;++g){const p=i[g-1],m=p.getStyleFunction()||e;if(!e)continue;let y=m(p,s);if(!y)continue;Array.isArray(y)||(y=[y]);const C=(g*f).toString(16).padStart(7,"#00000");for(let E=0,D=y.length;E<D;++E){const k=y[E],b=k.getGeometryFunction()(p);if(!b||!$(n,b.getExtent()))continue;const O=k.clone(),A=O.getFill();A&&A.setColor(C);const W=O.getStroke();W&&(W.setColor(C),W.setLineDash(null)),O.setText(void 0);const F=k.getImage();if(F&&F.getOpacity()!==0){const w=F.getImageSize();if(!w)continue;const M=Nt(w[0],w[1],void 0,{alpha:!1}),P=M.canvas;M.fillStyle=C,M.fillRect(0,0,P.width,P.height),O.setImage(new je({img:P,imgSize:w,anchor:F.getAnchor(),anchorXUnits:"pixels",anchorYUnits:"pixels",offset:F.getOrigin(),opacity:1,size:F.getSize(),scale:F.getScale(),rotation:F.getRotation(),rotateWithView:F.getRotateWithView()}))}const G=O.getZIndex()||0;let R=u[G];R||(R={},u[G]=R,R.Polygon=[],R.Circle=[],R.LineString=[],R.Point=[]);const L=b.getType();if(L==="GeometryCollection"){const w=b.getGeometriesArrayRecursive();for(let M=0,P=w.length;M<P;++M){const v=w[M];R[v.getType().replace("Multi","")].push(v,O)}}else R[L.replace("Multi","")].push(b,O)}}const x=Object.keys(u).map(Number).sort(Qt);for(let g=0,p=x.length;g<p;++g){const m=u[x[g]];for(const y in m){const I=m[y];for(let C=0,E=I.length;C<E;C+=2){d.setStyle(I[C+1]);for(let D=0,k=t.length;D<k;++D)d.setTransform(t[D]),d.drawGeometry(I[C])}}}return a.getImageData(0,0,h.width,h.height)}function Xi(_,t,i){const e=[];if(i){const n=Math.floor(Math.round(_[0])*j),s=Math.floor(Math.round(_[1])*j),o=(Ce(n,0,i.width-1)+Ce(s,0,i.height-1)*i.width)*4,r=i.data[o],l=i.data[o+1],h=i.data[o+2]+256*(l+256*r),d=Math.floor((256*256*256-1)/t.length);h&&h%d===0&&e.push(t[h/d-1])}return e}const Ni=.5,Fe={Point:Ui,LineString:Ki,Polygon:Qi,MultiPoint:$i,MultiLineString:zi,MultiPolygon:qi,GeometryCollection:ji,Circle:Hi};function Vi(_,t){return parseInt(Ct(_),10)-parseInt(Ct(t),10)}function Ji(_,t){const i=te(_,t);return i*i}function te(_,t){return Ni*_/t}function Hi(_,t,i,e,n){const s=i.getFill(),o=i.getStroke();if(s||o){const l=_.getBuilder(i.getZIndex(),"Circle");l.setFillStrokeStyle(s,o),l.drawCircle(t,e)}const r=i.getText();if(r&&r.getText()){const l=(n||_).getBuilder(i.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,e)}}function be(_,t,i,e,n,s,o){let r=!1;const l=i.getImage();if(l){const a=l.getImageState();a==xt.LOADED||a==xt.ERROR?l.unlistenImageChange(n):(a==xt.IDLE&&l.load(),l.listenImageChange(n),r=!0)}return Zi(_,t,i,e,s,o),r}function Zi(_,t,i,e,n,s){const o=i.getGeometryFunction()(t);if(!o)return;const r=o.simplifyTransformed(e,n);if(i.getRenderer())Me(_,r,i,t);else{const a=Fe[r.getType()];a(_,r,i,t,s)}}function Me(_,t,i,e){if(t.getType()=="GeometryCollection"){const s=t.getGeometries();for(let o=0,r=s.length;o<r;++o)Me(_,s[o],i,e);return}_.getBuilder(i.getZIndex(),"Default").drawCustom(t,e,i.getRenderer(),i.getHitDetectionRenderer())}function ji(_,t,i,e,n){const s=t.getGeometriesArray();let o,r;for(o=0,r=s.length;o<r;++o){const l=Fe[s[o].getType()];l(_,s[o],i,e,n)}}function Ki(_,t,i,e,n){const s=i.getStroke();if(s){const r=_.getBuilder(i.getZIndex(),"LineString");r.setFillStrokeStyle(null,s),r.drawLineString(t,e)}const o=i.getText();if(o&&o.getText()){const r=(n||_).getBuilder(i.getZIndex(),"Text");r.setTextStyle(o),r.drawText(t,e)}}function zi(_,t,i,e,n){const s=i.getStroke();if(s){const r=_.getBuilder(i.getZIndex(),"LineString");r.setFillStrokeStyle(null,s),r.drawMultiLineString(t,e)}const o=i.getText();if(o&&o.getText()){const r=(n||_).getBuilder(i.getZIndex(),"Text");r.setTextStyle(o),r.drawText(t,e)}}function qi(_,t,i,e,n){const s=i.getFill(),o=i.getStroke();if(o||s){const l=_.getBuilder(i.getZIndex(),"Polygon");l.setFillStrokeStyle(s,o),l.drawMultiPolygon(t,e)}const r=i.getText();if(r&&r.getText()){const l=(n||_).getBuilder(i.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,e)}}function Ui(_,t,i,e,n){const s=i.getImage(),o=i.getText();let r;if(s){if(s.getImageState()!=xt.LOADED)return;let l=_;if(n){const h=s.getDeclutterMode();if(h!=="none")if(l=n,h==="obstacle"){const d=_.getBuilder(i.getZIndex(),"Image");d.setImageStyle(s,r),d.drawPoint(t,e)}else o&&o.getText()&&(r={})}const a=l.getBuilder(i.getZIndex(),"Image");a.setImageStyle(s,r),a.drawPoint(t,e)}if(o&&o.getText()){let l=_;n&&(l=n);const a=l.getBuilder(i.getZIndex(),"Text");a.setTextStyle(o,r),a.drawText(t,e)}}function $i(_,t,i,e,n){const s=i.getImage(),o=i.getText();let r;if(s){if(s.getImageState()!=xt.LOADED)return;let l=_;if(n){const h=s.getDeclutterMode();if(h!=="none")if(l=n,h==="obstacle"){const d=_.getBuilder(i.getZIndex(),"Image");d.setImageStyle(s,r),d.drawMultiPoint(t,e)}else o&&o.getText()&&(r={})}const a=l.getBuilder(i.getZIndex(),"Image");a.setImageStyle(s,r),a.drawMultiPoint(t,e)}if(o&&o.getText()){let l=_;n&&(l=n);const a=l.getBuilder(i.getZIndex(),"Text");a.setTextStyle(o,r),a.drawText(t,e)}}function Qi(_,t,i,e,n){const s=i.getFill(),o=i.getStroke();if(s||o){const l=_.getBuilder(i.getZIndex(),"Polygon");l.setFillStrokeStyle(s,o),l.drawPolygon(t,e)}const r=i.getText();if(r&&r.getText()){const l=(n||_).getBuilder(i.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,e)}}class tn extends ci{constructor(t){super(t),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=Xt(),this.wrappedRenderedExtent_=Xt(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0,this.declutterExecutorGroup=null,this.clipping=!0,this.compositionContext_=null,this.opacity_=1}renderWorlds(t,i,e){const n=i.extent,s=i.viewState,o=s.center,r=s.resolution,l=s.projection,a=s.rotation,h=l.getExtent(),d=this.getLayer().getSource(),c=i.pixelRatio,f=i.viewHints,u=!(f[Dt.ANIMATING]||f[Dt.INTERACTING]),x=this.compositionContext_,g=Math.round(i.size[0]*c),p=Math.round(i.size[1]*c),m=d.getWrapX()&&l.canWrapX(),y=m?Ot(h):null,I=m?Math.ceil((n[2]-h[2])/y)+1:1;let C=m?Math.floor((n[0]-h[0])/y):0;do{const E=this.getRenderTransform(o,r,a,c,g,p,C*y);t.execute(x,1,E,a,u,void 0,e)}while(++C<I)}setupCompositionContext_(){if(this.opacity_!==1){const t=Nt(this.context.canvas.width,this.context.canvas.height,Ie);this.compositionContext_=t}else this.compositionContext_=this.context}releaseCompositionContext_(){if(this.opacity_!==1){const t=this.context.globalAlpha;this.context.globalAlpha=this.opacity_,this.context.drawImage(this.compositionContext_.canvas,0,0),this.context.globalAlpha=t,di(this.compositionContext_),Ie.push(this.compositionContext_.canvas),this.compositionContext_=null}}renderDeclutter(t){this.declutterExecutorGroup&&(this.setupCompositionContext_(),this.renderWorlds(this.declutterExecutorGroup,t,t.declutterTree),this.releaseCompositionContext_())}renderFrame(t,i){const e=t.pixelRatio,n=t.layerStatesArray[t.layerIndex];fi(this.pixelTransform,1/e,1/e),ui(this.inversePixelTransform,this.pixelTransform);const s=gi(this.pixelTransform);this.useContainer(i,s,this.getBackground(t));const o=this.context,r=o.canvas,l=this.replayGroup_,a=this.declutterExecutorGroup;if((!l||l.isEmpty())&&(!a||a.isEmpty()))return null;const h=Math.round(t.size[0]*e),d=Math.round(t.size[1]*e);r.width!=h||r.height!=d?(r.width=h,r.height=d,r.style.transform!==s&&(r.style.transform=s)):this.containerReused||o.clearRect(0,0,h,d),this.preRender(o,t);const c=t.viewState;c.projection,this.opacity_=n.opacity,this.setupCompositionContext_();let f=!1,u=!0;if(n.extent&&this.clipping){const x=_i(n.extent);u=$(x,t.extent),f=u&&!Ft(x,t.extent),f&&this.clipUnrotated(this.compositionContext_,t,x)}return u&&this.renderWorlds(l,t),f&&this.compositionContext_.restore(),this.releaseCompositionContext_(),this.postRender(o,t),this.renderedRotation_!==c.rotation&&(this.renderedRotation_=c.rotation,this.hitDetectionImageData_=null),this.container}getFeatures(t){return new Promise(i=>{if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const e=[this.context.canvas.width,this.context.canvas.height];ht(this.pixelTransform,e);const n=this.renderedCenter_,s=this.renderedResolution_,o=this.renderedRotation_,r=this.renderedProjection_,l=this.wrappedRenderedExtent_,a=this.getLayer(),h=[],d=e[0]*j,c=e[1]*j;h.push(this.getRenderTransform(n,s,o,j,d,c,0).slice());const f=a.getSource(),u=r.getExtent();if(f.getWrapX()&&r.canWrapX()&&!Ft(u,l)){let x=l[0];const g=Ot(u);let p=0,m;for(;x<u[0];)--p,m=g*p,h.push(this.getRenderTransform(n,s,o,j,d,c,m).slice()),x+=g;for(p=0,x=l[2];x>u[2];)++p,m=g*p,h.push(this.getRenderTransform(n,s,o,j,d,c,m).slice()),x-=g}this.hitDetectionImageData_=Yi(e,h,this.renderedFeatures_,a.getStyleFunction(),l,s,o)}i(Xi(t,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(t,i,e,n,s){if(!this.replayGroup_)return;const o=i.viewState.resolution,r=i.viewState.rotation,l=this.getLayer(),a={},h=function(f,u,x){const g=Ct(f),p=a[g];if(p){if(p!==!0&&x<p.distanceSq){if(x===0)return a[g]=!0,s.splice(s.lastIndexOf(p),1),n(f,l,u);p.geometry=u,p.distanceSq=x}}else{if(x===0)return a[g]=!0,n(f,l,u);s.push(a[g]={feature:f,layer:l,geometry:u,distanceSq:x,callback:n})}};let d;const c=[this.replayGroup_];return this.declutterExecutorGroup&&c.push(this.declutterExecutorGroup),c.some(f=>d=f.forEachFeatureAtCoordinate(t,o,r,e,h,f===this.declutterExecutorGroup&&i.declutterTree?i.declutterTree.all().map(u=>u.value):null)),d}handleFontsChanged(){const t=this.getLayer();t.getVisible()&&this.replayGroup_&&t.changed()}handleStyleImageChange_(t){this.renderIfReadyAndVisible()}prepareFrame(t){const i=this.getLayer(),e=i.getSource();if(!e)return!1;const n=t.viewHints[Dt.ANIMATING],s=t.viewHints[Dt.INTERACTING],o=i.getUpdateWhileAnimating(),r=i.getUpdateWhileInteracting();if(this.ready&&!o&&n||!r&&s)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const l=t.extent,a=t.viewState,h=a.projection,d=a.resolution,c=t.pixelRatio,f=i.getRevision(),u=i.getRenderBuffer();let x=i.getRenderOrder();x===void 0&&(x=Vi);const g=a.center.slice(),p=ee(l,u*d),m=p.slice(),y=[p.slice()],I=h.getExtent();if(e.getWrapX()&&h.canWrapX()&&!Ft(I,t.extent)){const R=Ot(I),L=Math.max(Ot(p)/2,R);p[0]=I[0]-L,p[2]=I[2]+L,xi(g,h);const w=pi(y[0],h);w[0]<I[0]&&w[2]<I[2]?y.push([w[0]+R,w[1],w[2]+R,w[3]]):w[0]>I[0]&&w[2]>I[2]&&y.push([w[0]-R,w[1],w[2]-R,w[3]])}if(this.ready&&this.renderedResolution_==d&&this.renderedRevision_==f&&this.renderedRenderOrder_==x&&Ft(this.wrappedRenderedExtent_,p))return Vt(this.renderedExtent_,m)||(this.hitDetectionImageData_=null,this.renderedExtent_=m),this.renderedCenter_=g,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const C=new ke(te(d,c),p,d,c);let E;this.getLayer().getDeclutter()&&(E=new ke(te(d,c),p,d,c));let D;for(let R=0,L=y.length;R<L;++R)e.loadFeatures(y[R],d,h);const k=Ji(d,c);let b=!0;const O=R=>{let L;const w=R.getStyleFunction()||i.getStyleFunction();if(w&&(L=w(R,d)),L){const M=this.renderFeature(R,k,L,C,D,E);b=b&&!M}},A=Si(p),W=e.getFeaturesInExtent(A);x&&W.sort(x);for(let R=0,L=W.length;R<L;++R)O(W[R]);this.renderedFeatures_=W,this.ready=b;const F=C.finish(),G=new Ee(p,d,c,e.getOverlaps(),F,i.getRenderBuffer());return E&&(this.declutterExecutorGroup=new Ee(p,d,c,e.getOverlaps(),E.finish(),i.getRenderBuffer())),this.renderedResolution_=d,this.renderedRevision_=f,this.renderedRenderOrder_=x,this.renderedExtent_=m,this.wrappedRenderedExtent_=p,this.renderedCenter_=g,this.renderedProjection_=h,this.replayGroup_=G,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(t,i,e,n,s,o){if(!e)return!1;let r=!1;if(Array.isArray(e))for(let l=0,a=e.length;l<a;++l)r=be(n,t,e[l],i,this.boundHandleStyleImageChange_,s,o)||r;else r=be(n,t,e,i,this.boundHandleStyleImageChange_,s,o);return r}}const en=tn;class nn extends Ke{constructor(t){super(t)}createRenderer(){return new en(this)}}const rn=nn;export{Gi as C,rn as V,Ji as g};
